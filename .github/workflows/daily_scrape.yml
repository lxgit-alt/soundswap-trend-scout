name: SoundSwap Daily Blog Scout

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at 12:00 UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  daily-blog-scout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Debug - Show Secrets Status
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "Checking environment variables..."
          # Now accessing via env vars, which is safer and fixes the syntax error
          if [ -n "$VERCEL_URL" ]; then
            echo "âœ“ VERCEL_URL is set"
            echo "URL length: ${#VERCEL_URL} characters"
          else
            echo "âœ— VERCEL_URL is NOT set or empty"
            echo "You need to add VERCEL_URL to GitHub Secrets"
          fi
          
          if [ -n "$CRON_SECRET" ]; then
            echo "âœ“ CRON_SECRET is set"
          else
            echo "âš  CRON_SECRET is not set (optional)"
          fi

      - name: Trigger Daily Scout
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          echo "ðŸš€ Triggering daily scout job..."
          
          # Validate URL format
          if [[ ! $VERCEL_URL =~ ^https?:// ]]; then
            echo "âŒ ERROR: VERCEL_URL must start with http:// or https://"
            echo "Current value: '$VERCEL_URL'"
            echo "Please set VERCEL_URL in GitHub Secrets to your deployed Vercel URL"
            exit 1
          fi
          
          # Construct full API URL
          API_URL="${VERCEL_URL%/}/api/scout"
          echo "ðŸ“¡ Calling: $API_URL"
          
          # Set up curl options
          CURL_OPTS=(
            -X GET
            -H "Content-Type: application/json"
            --max-time 30
            --retry 2
            --retry-delay 5
          )
          
          # Add authorization if CRON_SECRET is set
          if [ -n "$CRON_SECRET" ]; then
            CURL_OPTS+=(-H "Authorization: Bearer $CRON_SECRET")
            echo "ðŸ” Using authorization token"
          else
            echo "âš  No authorization token set (CRON_SECRET)"
          fi
          
          # Make the request
          curl "${CURL_OPTS[@]}" "$API_URL" || {
            echo "âš  Curl command failed, but scout may still be running in background"
            echo "Check Vercel logs for actual execution status"
          }
          
          echo "âœ… Scout job triggered"
          echo "ðŸ“Š Check Discord channel for daily topics within 60 seconds"
          echo "ðŸ“‹ Check Vercel logs for any execution errors"

      - name: Verify Health (Optional)
        if: success()
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
        run: |
          echo "ðŸ“Š Checking service health..."
          HEALTH_URL="${VERCEL_URL%/}/health"
          
          if curl -s --max-time 10 "$HEALTH_URL" > /tmp/health_response; then
            echo "âœ… Health check successful:"
            cat /tmp/health_response
          else
            echo "âš  Health check failed - service might still be starting"
            echo "This is normal if the service was idle and needs to warm up"
          fi

      - name: Notify Completion
        if: always()
        run: |
          echo "âœ… GitHub Actions workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "----------------------------------------"
          echo "Next steps:"
          echo "1. Check your Discord channel for the daily topics report"
          echo "2. If no report appears in 2 minutes, check Vercel logs"
          echo "3. Users can use /blog command to generate full articles"
          echo "----------------------------------------"
          echo "To debug:"
          echo "- Visit: ${{ secrets.VERCEL_URL }}/health"
          echo "- Check Vercel dashboard logs"
          echo "- Verify Discord bot has proper permissions"