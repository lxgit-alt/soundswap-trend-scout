name: SoundSwap Daily Blog Scout

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 09:00 UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  daily-blog-scout:
    runs-on: ubuntu-latest
    env:
      VERCEL_URL: ${{ secrets.VERCEL_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Debug - Show Environment Status
        run: |
          echo "Checking environment variables..."
          
          # Check required variables
          REQUIRED_VARS=("SERPAPI_KEY" "DISCORD_BOT_TOKEN" "DISCORD_CHANNEL_ID")
          ALL_SET=true
          
          for var in "${REQUIRED_VARS[@]}"; do
            # Step 1: Get the value of the variable whose name is stored in $var
            val="${!var}"
            
            if [ -z "$val" ]; then
              echo "‚ùå $var is NOT set"
              ALL_SET=false
            else
              # Step 2: Get the length of the string stored in $val
              echo "‚úì $var is set (length: ${#val} chars)"
            fi
          done
          
          if [ "$ALL_SET" = false ]; then
            echo "üö® ERROR: Missing required environment variables!"
            echo "Please set all required variables in GitHub Secrets:"
            echo "1. SERPAPI_KEY"
            echo "2. DISCORD_BOT_TOKEN"
            echo "3. DISCORD_CHANNEL_ID"
            exit 1
          fi
          
          # Check optional variables
          if [ -n "$VERCEL_URL" ]; then
            echo "‚úì VERCEL_URL is set (length: ${#VERCEL_URL} chars)"
          else
            echo "‚ö† VERCEL_URL is not set (optional for direct API call)"
          fi
          
          if [ -n "$CRON_SECRET" ]; then
            echo "‚úì CRON_SECRET is set"
          else
            echo "‚ö† CRON_SECRET is not set (optional for direct API call)"
          fi

      - name: Run Enhanced Daily Scout
        id: scout
        continue-on-error: true
        run: |
          echo "üöÄ Starting enhanced daily scout script..."
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          
          # Create enhanced scout script with rotating queries
          cat > scout-runner.js << 'EOF'
          import fetch from 'node-fetch';
          
          // Configuration
          const SERPAPI_KEY = process.env.SERPAPI_KEY;
          const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN;
          const DISCORD_CHANNEL_ID = process.env.DISCORD_CHANNEL_ID;
          
          // Dynamic query generation based on day of week
          function generateDailyQueries() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
            const dayOfMonth = now.getDate();
            const weekOfYear = Math.floor(dayOfMonth / 7) + 1;
            const month = now.getMonth(); // 0-11
            const year = now.getFullYear();
            
            // Monthly themes to prevent repetition
            const monthlyThemes = [
              'AI Music Production Tools',
              'Music Gear Releases',
              'Music Industry News',
              'Audio Technology',
              'Music Business Trends',
              'Creative Production Techniques'
            ];
            
            const theme = monthlyThemes[month % monthlyThemes.length];
            
            // Query pools for each category
            const aiToolsQueries = [
              `latest AI audio tools ${month + 1}/${year}`,
              `AI music production software ${year}`,
              `best AI plugins for producers ${month + 1}/${year}`,
              `AI mastering tools reviews ${year}`,
              `artificial intelligence in music production`,
              `AI vocal processing ${month + 1} ${year}`,
              `machine learning music composition`,
              `AI beat making tools ${year}`
            ];
            
            const gearQueries = [
              `new music production gear ${month + 1}/${year}`,
              `audio interface releases ${year}`,
              `studio monitor reviews ${month + 1} ${year}`,
              `MIDI controller latest models ${year}`,
              `synthesizer new releases ${month + 1}/${year}`,
              `microphones for home studio ${year}`,
              `DAW updates ${month + 1} ${year}`,
              `music production hardware ${year}`
            ];
            
            const newsQueries = [
              `music industry news ${month + 1}/${year}`,
              `streaming services updates ${year}`,
              `music copyright laws ${month + 1} ${year}`,
              `artist revenue trends ${year}`,
              `music marketing strategies ${month + 1}/${year}`,
              `independent musician news ${year}`,
              `record label developments ${month + 1} ${year}`,
              `music distribution platforms ${year}`
            ];
            
            const trendingQueries = [
              `viral music production trends ${month + 1}/${year}`,
              `what producers are talking about ${year}`,
              `emerging music technologies ${month + 1} ${year}`,
              `music production on social media ${year}`,
              `creative workflows ${month + 1}/${year}`,
              `music collaboration tools ${year}`,
              `home studio setup trends ${month + 1} ${year}`,
              `music education online ${year}`
            ];
            
            // Rotate queries based on day
            const dayIndex = dayOfMonth % 8;
            const weekIndex = weekOfYear % 8;
            const dayOfWeekIndex = dayOfWeek;
            
            // Generate 4 unique queries with rotating selection
            const queries = [
              aiToolsQueries[(dayIndex + dayOfWeekIndex) % aiToolsQueries.length],
              gearQueries[(dayIndex + weekIndex) % gearQueries.length],
              newsQueries[(dayOfMonth + dayOfWeekIndex) % newsQueries.length],
              trendingQueries[(dayIndex + month) % trendingQueries.length]
            ];
            
            console.log(`\nüìÖ Date: ${now.toISOString().split('T')[0]}`);
            console.log(`üéØ Theme: ${theme}`);
            console.log(`üîç Generated queries:`);
            queries.forEach((q, i) => console.log(`  ${i+1}. ${q}`));
            
            return {
              queries,
              theme,
              dateInfo: {
                dayOfWeek: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                dayOfMonth,
                month: month + 1,
                year
              }
            };
          }
          
          async function getSerpData(query, context = {}) {
            try {
              console.log(`üîç Fetching SERP data for: ${query}`);
              
              // Add freshness modifier based on context
              const tbsModifier = context.isNews ? 'qdr:d' : 'qdr:w'; // day for news, week for others
              
              const searchUrl = `https://serpapi.com/search?q=${encodeURIComponent(query)}&tbs=${tbsModifier}&num=10&api_key=${SERPAPI_KEY}`;
              const searchResponse = await fetch(searchUrl);
              const searchData = await searchResponse.json();
              
              console.log(`‚úÖ SERP data received for: ${query.slice(0, 40)}...`);
              
              // Extract organic results
              const organic = searchData.organic_results || [];
              
              // Filter out unwanted domains
              const excludedDomains = [
                'facebook.com', 'twitter.com', 'instagram.com', 
                'youtube.com', 'reddit.com', 'tiktok.com',
                'pinterest.com', 'linkedin.com', 'quora.com',
                'wikipedia.org', 'yelp.com', 'amazon.com',
                'ebay.com', 'etsy.com', 'spotify.com'
              ];
              
              // Find high-quality results
              let bestResult = {};
              let secondaryResult = {};
              
              for (const result of organic) {
                if (!result.link || !result.title) continue;
                
                try {
                  const url = new URL(result.link);
                  const hostname = url.hostname.toLowerCase();
                  
                  // Skip excluded domains
                  if (excludedDomains.some(domain => hostname.includes(domain))) {
                    continue;
                  }
                  
                  // Quality scoring system
                  let qualityScore = 0;
                  
                  // Premium domains get highest priority
                  const premiumDomains = [
                    'musictech.com', 'musically.com', 'digitalmusicnews.com',
                    'billboard.com', 'rollingstone.com', 'nme.com',
                    'variety.com', 'soundonsound.com', 'musicradar.com',
                    'producerspot.com', 'attackmagazine.com', 'futuremusic.com',
                    'thewire.co.uk', 'residentadvisor.net', 'mixmag.net'
                  ];
                  
                  const industryDomains = [
                    'theverge.com', 'techcrunch.com', 'wired.com',
                    'engadget.com', 'arstechnica.com', 'gizmodo.com',
                    'forbes.com', 'businessinsider.com', 'bloomberg.com',
                    'reuters.com', 'apnews.com', 'bbc.com'
                  ];
                  
                  if (premiumDomains.some(domain => hostname.includes(domain))) {
                    qualityScore += 30;
                  } else if (industryDomains.some(domain => hostname.includes(domain))) {
                    qualityScore += 20;
                  }
                  
                  // Content quality checks
                  if (result.title.length > 20 && result.title.length < 100) qualityScore += 10;
                  if (result.snippet && result.snippet.length > 100) qualityScore += 15;
                  if (result.date) qualityScore += 10; // Has publication date
                  
                  // Update best result if higher quality
                  if (qualityScore > (bestResult.qualityScore || 0)) {
                    if (bestResult.title) {
                      secondaryResult = { ...bestResult };
                    }
                    bestResult = {
                      ...result,
                      qualityScore,
                      hostname
                    };
                  } else if (qualityScore > (secondaryResult.qualityScore || 0)) {
                    secondaryResult = {
                      ...result,
                      qualityScore,
                      hostname
                    };
                  }
                  
                } catch (e) {
                  // Invalid URL, skip
                }
              }
              
              // Use best result, fallback to first organic
              const firstResult = bestResult.title ? bestResult : (organic[0] || {});
              
              // Extract People Also Ask questions
              let questions = [];
              const questionSources = [
                searchData.related_questions,
                searchData.related_questions_and_answers,
                searchData.inline_questions,
                searchData.organic_results?.[0]?.related_questions
              ];
              
              for (const source of questionSources) {
                if (Array.isArray(source) && source.length > 0) {
                  source.slice(0, 5).forEach(item => {
                    if (item.question) questions.push(item.question);
                    else if (typeof item === 'string') questions.push(item);
                  });
                  if (questions.length >= 3) break;
                }
              }
              
              // Generate context-relevant fallback questions
              if (questions.length < 3) {
                const queryWords = query.toLowerCase().split(' ').slice(0, 4);
                const fallbacks = [
                  `What are the latest developments in ${queryWords.slice(0, 3).join(' ')}?`,
                  `How is ${queryWords.slice(0, 2).join(' ')} impacting modern music production?`,
                  `What should producers know about ${queryWords.slice(0, 2).join(' ')} in ${new Date().getFullYear()}?`,
                  `How can artists use ${queryWords.slice(0, 2).join(' ')} to improve their workflow?`,
                  `What are the benefits of ${queryWords.slice(0, 2).join(' ')} for independent musicians?`
                ];
                questions = [...questions, ...fallbacks.slice(0, 5 - questions.length)];
              }
              
              // Remove duplicates
              questions = [...new Set(questions)].slice(0, 5);
              
              // Calculate trend score with enhanced metrics
              let trendScore = 40; // Base score
              
              // Recency bonus
              trendScore += 25;
              
              // Volume bonus
              const totalResults = searchData.search_information?.total_results || 0;
              if (totalResults > 1000000) trendScore += 10;
              if (totalResults > 5000000) trendScore += 5;
              if (totalResults > 10000000) trendScore += 5;
              
              // Quality bonus
              if (firstResult.qualityScore > 30) trendScore += 15;
              else if (firstResult.qualityScore > 20) trendScore += 10;
              else if (firstResult.qualityScore > 10) trendScore += 5;
              
              // Questions bonus (indicates search interest)
              if (questions.length >= 3) trendScore += 5;
              
              // Clamp score
              trendScore = Math.min(Math.max(trendScore, 40), 95);
              
              // Determine status
              let status = 'üìä STEADY';
              if (trendScore > 75) status = 'üî• VIRAL';
              else if (trendScore > 60) status = 'üìà TRENDING';
              
              // Categorize the topic
              let category = 'OTHER';
              const queryLower = query.toLowerCase();
              if (queryLower.includes('ai') || queryLower.includes('artificial')) category = 'ü§ñ AI TOOLS';
              else if (queryLower.includes('gear') || queryLower.includes('hardware') || queryLower.includes('equipment')) category = 'üéõÔ∏è GEAR';
              else if (queryLower.includes('news') || queryLower.includes('industry') || queryLower.includes('trend')) category = 'üì∞ NEWS';
              else if (queryLower.includes('production') || queryLower.includes('studio') || queryLower.includes('recording')) category = 'üéöÔ∏è PRODUCTION';
              
              return {
                query,
                category,
                score: Math.round(trendScore),
                link: firstResult.link || 'https://example.com/no-link-found',
                title: firstResult.title || `Latest updates: ${query.slice(0, 50)}`,
                snippet: firstResult.snippet || `Stay informed about ${query.slice(0, 30)}...`,
                questions,
                status,
                total_results: totalResults,
                quality_score: firstResult.qualityScore || 0,
                source: firstResult.hostname || 'unknown'
              };
              
            } catch (error) {
              console.error(`‚ùå SERP API error for "${query}":`, error.message);
              
              return {
                query,
                category: 'ERROR',
                score: 40,
                link: 'https://example.com/no-link-found',
                title: `Error fetching data for: ${query.slice(0, 40)}`,
                snippet: `Unable to retrieve information. Please try again or check the logs.`,
                questions: [
                  `What is the latest in ${query.split(' ').slice(0, 2).join(' ')}?`,
                  `How does ${query.split(' ').slice(0, 2).join(' ')} affect music production?`,
                  `What are the trends in ${query.split(' ').slice(0, 2).join(' ')}?`
                ],
                status: '‚ùå ERROR',
                total_results: 0,
                quality_score: 0,
                source: 'error'
              };
            }
          }
          
          async function sendToDiscordChannel(content) {
            try {
              const url = `https://discord.com/api/v10/channels/${DISCORD_CHANNEL_ID}/messages`;
              
              console.log('üì§ Sending message to Discord channel...');
              
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Authorization': `Bot ${DISCORD_BOT_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content.slice(0, 2000) })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Discord API error: ${response.status} - ${errorText}`);
              } else {
                console.log('‚úÖ Message sent to Discord successfully');
              }
            } catch (error) {
              console.error('‚ùå Failed to send to Discord channel:', error);
              throw error;
            }
          }
          
          async function runEnhancedDailyScout() {
            try {
              console.log('üéØ Starting enhanced daily scout...');
              
              // Generate dynamic queries
              const { queries, theme, dateInfo } = generateDailyQueries();
              const dailyTopics = [];
              
              // Get SERP data for each query
              for (let i = 0; i < queries.length; i++) {
                const query = queries[i];
                try {
                  const serpData = await getSerpData(query, {
                    isNews: query.toLowerCase().includes('news')
                  });
                  dailyTopics.push({
                    ...serpData,
                    index: i
                  });
                  console.log(`‚úÖ Processed query ${i + 1}: ${query.slice(0, 40)}...`);
                  await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
                } catch (error) {
                  console.error(`‚ùå Error processing query "${query}":`, error);
                }
              }
              
              // Build enhanced report
              const dateStr = new Date().toISOString().split('T')[0];
              let report = `üé∏ **SOUNDSWAP DAILY BLOG SCOUT**\n`;
              report += `üìÖ ${dateInfo.dayOfWeek}, ${dateInfo.month}/${dateInfo.dayOfMonth}/${dateInfo.year}\n`;
              report += `üéØ Monthly Theme: ${theme}\n\n`;
              report += "**Choose ONE topic for today's semantic SEO blog:**\n\n";
              
              // Sort by score for better presentation
              dailyTopics.sort((a, b) => b.score - a.score);
              
              for (let i = 0; i < dailyTopics.length; i++) {
                const topic = dailyTopics[i];
                const emoji = ["üî•", "üìà", "üéØ", "‚ö°"][i] || "üìù";
                const categoryEmoji = topic.category;
                const paaPreview = topic.questions?.length > 0 ? 
                  `${topic.questions[0].slice(0, 50)}...` : "What music creators need to know";
                
                report += `${emoji} **${categoryEmoji} ${topic.query.slice(0, 50)}...**\n`;
                report += `   üìä Trend Score: ${topic.score}/100 ${topic.status}\n`;
                report += `   üè∑Ô∏è Source: ${topic.source || 'Various'}\n`;
                report += `   üîó Reference: ${topic.link.slice(0, 60)}...\n`;
                report += `   ‚ùì Top PAA: ${paaPreview}\n\n`;
              }
              
              report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
              report += "**üí° BLOG GENERATION INSTRUCTIONS:**\n";
              report += "1. Type `/blog` in this channel\n";
              report += "2. Choose topic number (1-4)\n";
              report += "3. Select outline style\n";
              report += "4. Get full semantic SEO blog with PAA ‚Üí H3 headers!\n\n";
              report += "**üéØ TODAY'S FOCUS AREAS:**\n";
              report += "- ü§ñ AI Tools for Music Production\n";
              report += "- üéõÔ∏è Latest Music Gear & Hardware\n";
              report += "- üì∞ Music Industry News & Trends\n";
              report += "- üéöÔ∏è Creative Production Techniques\n\n";
              report += "‚è±Ô∏è *Only 1 high-quality blog per day for maximum SEO impact*\n";
              report += "‚úÖ *Previous blogs indexed in <5 hours*";
              
              // Send to Discord
              await sendToDiscordChannel(report);
              
              console.log('‚úÖ Enhanced daily scout completed successfully');
              
              return {
                success: true,
                date: dateStr,
                theme,
                topicsProcessed: dailyTopics.length,
                discordSent: true,
                topics: dailyTopics.map(t => ({
                  query: t.query,
                  score: t.score,
                  category: t.category
                })),
                timestamp: new Date().toISOString()
              };
              
            } catch (error) {
              console.error('‚ùå Scout execution error:', error);
              throw error;
            }
          }
          
          // Execute
          runEnhancedDailyScout().then(result => {
            console.log('üéâ Enhanced scout completed:', JSON.stringify(result, null, 2));
            process.exit(0);
          }).catch(error => {
            console.error('üí• Scout failed:', error);
            process.exit(1);
          });
          EOF
          
          # Run the enhanced scout script
          node scout-runner.js
          
          # Save the exit code
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT

      - name: Trigger Vercel Endpoint (Fallback)
        if: steps.scout.outputs.EXIT_CODE != '0' && env.VERCEL_URL != '' && env.CRON_SECRET != ''
        run: |
          echo "üîÑ Falling back to Vercel endpoint..."
          
          # Validate URL format
          if [[ ! $VERCEL_URL =~ ^https?:// ]]; then
            echo "‚ùå ERROR: VERCEL_URL must start with http:// or https://"
            exit 1
          fi
          
          # Construct full API URL
          API_URL="${VERCEL_URL%/}/api/scout-direct"
          echo "üì° Calling: $API_URL"
          
          # Set up curl options
          CURL_OPTS=(
            -X POST
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $CRON_SECRET"
            --max-time 60
            --retry 2
            --retry-delay 5
          )
          
          # Make the request
          if curl "${CURL_OPTS[@]}" "$API_URL"; then
            echo "‚úÖ Vercel endpoint triggered successfully"
          else
            echo "‚ùå Failed to trigger Vercel endpoint"
          fi

      - name: Notify Completion
        if: always()
        run: |
          echo "‚úÖ GitHub Actions workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "----------------------------------------"
          echo "üéØ TODAY'S IMPROVEMENTS:"
          echo "‚Ä¢ Dynamic query rotation prevents repetition"
          echo "‚Ä¢ Enhanced focus on AI tools, gear, news"
          echo "‚Ä¢ Monthly themes for content variety"
          echo "‚Ä¢ Quality scoring for better source selection"
          echo "----------------------------------------"
          echo "üìä Next steps:"
          echo "1. Check your Discord channel for 4 fresh topics"
          echo "2. Each day will have different queries"
          echo "3. Better category focus (AI, Gear, News, Trends)"
          echo "4. Continue getting blogs indexed in <5 hours"
          echo "----------------------------------------"
          
          # Output status based on exit code
          if [ "${{ steps.scout.outputs.EXIT_CODE }}" = "0" ]; then
            echo "üéâ Enhanced scout executed successfully!"
            echo "üìà Topics will rotate daily to prevent repetition"
          else
            echo "‚ö† Scout script may have encountered issues"
            echo "Check the logs above for error details"
          fi