name: SoundSwap Daily Blog Scout

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 09:00 UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  daily-blog-scout:
    runs-on: ubuntu-latest
    env:
      VERCEL_URL: ${{ secrets.VERCEL_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Debug - Show Environment Status
        run: |
          echo "Checking environment variables..."
          
          # Check required variables
          REQUIRED_VARS=("SERPAPI_KEY" "DISCORD_BOT_TOKEN" "DISCORD_CHANNEL_ID")
          ALL_SET=true
          
          for var in "${REQUIRED_VARS[@]}"; do
            # Step 1: Get the value of the variable whose name is stored in $var
            val="${!var}"
            
            if [ -z "$val" ]; then
              echo "‚ùå $var is NOT set"
              ALL_SET=false
            else
              # Step 2: Get the length of the string stored in $val
              echo "‚úì $var is set (length: ${#val} chars)"
            fi
          done
          
          if [ "$ALL_SET" = false ]; then
            echo "üö® ERROR: Missing required environment variables!"
            echo "Please set all required variables in GitHub Secrets:"
            echo "1. SERPAPI_KEY"
            echo "2. DISCORD_BOT_TOKEN"
            echo "3. DISCORD_CHANNEL_ID"
            exit 1
          fi
          
          # Check optional variables
          if [ -n "$VERCEL_URL" ]; then
            echo "‚úì VERCEL_URL is set (length: ${#VERCEL_URL} chars)"
          else
            echo "‚ö† VERCEL_URL is not set (optional for direct API call)"
          fi
          
          if [ -n "$CRON_SECRET" ]; then
            echo "‚úì CRON_SECRET is set"
          else
            echo "‚ö† CRON_SECRET is not set (optional for direct API call)"
          fi

      - name: Run Enhanced Daily Scout with AI APIs
        id: scout
        continue-on-error: true
        run: |
          echo "üöÄ Starting enhanced daily scout script with AI APIs..."
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          
          # Create enhanced scout script with AI Mode and AI Overview APIs
          cat > scout-runner.js << 'EOF'
          import fetch from 'node-fetch';
          
          // Configuration
          const SERPAPI_KEY = process.env.SERPAPI_KEY;
          const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN;
          const DISCORD_CHANNEL_ID = process.env.DISCORD_CHANNEL_ID;
          
          // Dynamic query generation based on day of week
          function generateDailyQueries() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 6 = Saturday
            const dayOfMonth = now.getDate();
            const weekOfYear = Math.floor(dayOfMonth / 7) + 1;
            const month = now.getMonth(); // 0-11
            const year = now.getFullYear();
            
            // Monthly themes to prevent repetition
            const monthlyThemes = [
              'AI Music Production Tools',
              'Music Gear Releases',
              'Music Industry News',
              'Audio Technology',
              'Music Business Trends',
              'Creative Production Techniques'
            ];
            
            const theme = monthlyThemes[month % monthlyThemes.length];
            
            // Query pools for each category
            const aiToolsQueries = [
              `latest AI audio tools ${month + 1}/${year}`,
              `AI music production software ${year}`,
              `best AI plugins for producers ${month + 1}/${year}`,
              `AI mastering tools reviews ${year}`,
              `artificial intelligence in music production`,
              `AI vocal processing ${month + 1} ${year}`,
              `machine learning music composition`,
              `AI beat making tools ${year}`
            ];
            
            const gearQueries = [
              `new music production gear ${month + 1}/${year}`,
              `audio interface releases ${year}`,
              `studio monitor reviews ${month + 1} ${year}`,
              `MIDI controller latest models ${year}`,
              `synthesizer new releases ${month + 1}/${year}`,
              `microphones for home studio ${year}`,
              `DAW updates ${month + 1} ${year}`,
              `music production hardware ${year}`
            ];
            
            const newsQueries = [
              `music industry news ${month + 1}/${year}`,
              `streaming services updates ${year}`,
              `music copyright laws ${month + 1} ${year}`,
              `artist revenue trends ${year}`,
              `music marketing strategies ${month + 1}/${year}`,
              `independent musician news ${year}`,
              `record label developments ${month + 1} ${year}`,
              `music distribution platforms ${year}`
            ];
            
            const trendingQueries = [
              `viral music production trends ${month + 1}/${year}`,
              `what producers are talking about ${year}`,
              `emerging music technologies ${month + 1} ${year}`,
              `music production on social media ${year}`,
              `creative workflows ${month + 1}/${year}`,
              `music collaboration tools ${year}`,
              `home studio setup trends ${month + 1} ${year}`,
              `music education online ${year}`
            ];
            
            // Rotate queries based on day
            const dayIndex = dayOfMonth % 8;
            const weekIndex = weekOfYear % 8;
            const dayOfWeekIndex = dayOfWeek;
            
            // Generate 4 unique queries with rotating selection
            const queries = [
              aiToolsQueries[(dayIndex + dayOfWeekIndex) % aiToolsQueries.length],
              gearQueries[(dayIndex + weekIndex) % gearQueries.length],
              newsQueries[(dayOfMonth + dayOfWeekIndex) % newsQueries.length],
              trendingQueries[(dayIndex + month) % trendingQueries.length]
            ];
            
            console.log(`\nüìÖ Date: ${now.toISOString().split('T')[0]}`);
            console.log(`üéØ Theme: ${theme}`);
            console.log(`üîç Generated queries:`);
            queries.forEach((q, i) => console.log(`  ${i+1}. ${q}`));
            
            return {
              queries,
              theme,
              dateInfo: {
                dayOfWeek: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                dayOfMonth,
                month: month + 1,
                year
              }
            };
          }
          
          // Google AI Mode API - For AI-generated search results
          async function getGoogleAIModeData(query) {
            try {
              console.log(`ü§ñ Fetching Google AI Mode data for: ${query.slice(0, 40)}...`);
              
              const url = `https://serpapi.com/search?engine=google_ai_mode&q=${encodeURIComponent(query)}&api_key=${SERPAPI_KEY}`;
              const response = await fetch(url);
              const data = await response.json();
              
              if (data.error) {
                console.log(`‚ùå Google AI Mode API error: ${data.error}`);
                return null;
              }
              
              console.log(`‚úÖ Google AI Mode data received`);
              return data;
            } catch (error) {
              console.error(`‚ùå Google AI Mode API failed:`, error.message);
              return null;
            }
          }
          
          // Google AI Overview API - For AI Overview blocks
          async function getGoogleAIOverviewData(query) {
            try {
              console.log(`üß† Fetching Google AI Overview data for: ${query.slice(0, 40)}...`);
              
              const url = `https://serpapi.com/search?engine=google_ai_overview&q=${encodeURIComponent(query)}&api_key=${SERPAPI_KEY}`;
              const response = await fetch(url);
              const data = await response.json();
              
              if (data.error) {
                console.log(`‚ùå Google AI Overview API error: ${data.error}`);
                return null;
              }
              
              console.log(`‚úÖ Google AI Overview data received`);
              return data;
            } catch (error) {
              console.error(`‚ùå Google AI Overview API failed:`, error.message);
              return null;
            }
          }
          
          // Main SERP data function with AI APIs
          async function getEnhancedSerpData(query, context = {}) {
            try {
              console.log(`üîç Fetching enhanced SERP data for: ${query}`);
              
              // Parallel API calls for better performance
              const [regularData, aiModeData, aiOverviewData] = await Promise.allSettled([
                getRegularSerpData(query, context),
                getGoogleAIModeData(query),
                getGoogleAIOverviewData(query)
              ]);
              
              const searchData = regularData.status === 'fulfilled' ? regularData.value : null;
              const aiMode = aiModeData.status === 'fulfilled' ? aiModeData.value : null;
              const aiOverview = aiOverviewData.status === 'fulfilled' ? aiOverviewData.value : null;
              
              if (!searchData) {
                throw new Error('Failed to get regular search data');
              }
              
              // Combine AI data with regular data
              let combinedQuestions = [...(searchData.questions || [])];
              let aiInsights = [];
              
              // Extract from AI Mode
              if (aiMode && aiMode.organic_results) {
                // Get AI-generated summaries
                const aiResults = aiMode.organic_results.slice(0, 3).filter(r => r.snippet);
                aiInsights = aiResults.map(r => r.snippet);
                
                // Extract questions from AI Mode
                if (aiMode.related_questions) {
                  const aiQuestions = aiMode.related_questions
                    .slice(0, 5)
                    .map(q => q.question || q)
                    .filter(q => q && typeof q === 'string');
                  combinedQuestions = [...combinedQuestions, ...aiQuestions];
                }
              }
              
              // Extract from AI Overview
              if (aiOverview && aiOverview.ai_overview) {
                const overview = aiOverview.ai_overview;
                if (overview.text) {
                  aiInsights.push(overview.text.substring(0, 200) + '...');
                }
                
                if (overview.questions) {
                  const overviewQuestions = overview.questions
                    .slice(0, 5)
                    .map(q => q.question || q)
                    .filter(q => q && typeof q === 'string');
                  combinedQuestions = [...combinedQuestions, ...overviewQuestions];
                }
              }
              
              // Remove duplicates and limit
              const uniqueQuestions = [...new Set(combinedQuestions)].slice(0, 7);
              
              // Calculate enhanced trend score with AI bonus
              let trendScore = searchData.score || 40;
              
              // AI data bonus
              if (aiMode || aiOverview) {
                trendScore += 15; // Bonus for having AI-generated content
                console.log(`‚ú® AI data bonus applied for: ${query.slice(0, 40)}...`);
              }
              
              // Multiple AI sources bonus
              if (aiMode && aiOverview) {
                trendScore += 10;
              }
              
              // AI insights bonus
              if (aiInsights.length > 0) {
                trendScore += Math.min(aiInsights.length * 3, 15);
              }
              
              // Determine status
              let status = 'üìä STEADY';
              if (trendScore > 75) status = 'üî• VIRAL';
              else if (trendScore > 60) status = 'üìà TRENDING';
              
              if (aiMode || aiOverview) {
                status = 'ü§ñ ' + status; // Add AI indicator
              }
              
              return {
                query,
                category: searchData.category,
                score: Math.min(Math.round(trendScore), 100),
                link: searchData.link,
                title: searchData.title,
                snippet: searchData.snippet,
                questions: uniqueQuestions,
                status,
                total_results: searchData.total_results,
                quality_score: searchData.quality_score,
                source: searchData.source,
                ai_enhanced: !!(aiMode || aiOverview),
                ai_insights: aiInsights.slice(0, 2)
              };
              
            } catch (error) {
              console.error(`‚ùå Enhanced SERP error for "${query}":`, error.message);
              return getFallbackSerpData(query);
            }
          }
          
          // Regular SERP data function
          async function getRegularSerpData(query, context = {}) {
            try {
              // Add freshness modifier based on context
              const tbsModifier = context.isNews ? 'qdr:d' : 'qdr:w';
              
              const searchUrl = `https://serpapi.com/search?q=${encodeURIComponent(query)}&tbs=${tbsModifier}&num=10&api_key=${SERPAPI_KEY}`;
              const searchResponse = await fetch(searchUrl);
              const searchData = await searchResponse.json();
              
              // Extract organic results
              const organic = searchData.organic_results || [];
              
              // Filter out unwanted domains
              const excludedDomains = [
                'facebook.com', 'twitter.com', 'instagram.com', 
                'youtube.com', 'reddit.com', 'tiktok.com',
                'pinterest.com', 'linkedin.com', 'quora.com',
                'wikipedia.org', 'yelp.com', 'amazon.com',
                'ebay.com', 'etsy.com', 'spotify.com'
              ];
              
              // Find high-quality results
              let bestResult = {};
              let qualityScore = 0;
              
              for (const result of organic) {
                if (!result.link || !result.title) continue;
                
                try {
                  const url = new URL(result.link);
                  const hostname = url.hostname.toLowerCase();
                  
                  // Skip excluded domains
                  if (excludedDomains.some(domain => hostname.includes(domain))) {
                    continue;
                  }
                  
                  let currentScore = 0;
                  
                  // Premium domains get highest priority
                  const premiumDomains = [
                    'musictech.com', 'musically.com', 'digitalmusicnews.com',
                    'billboard.com', 'rollingstone.com', 'nme.com',
                    'variety.com', 'soundonsound.com', 'musicradar.com',
                    'producerspot.com', 'attackmagazine.com', 'futuremusic.com',
                    'thewire.co.uk', 'residentadvisor.net', 'mixmag.net'
                  ];
                  
                  const industryDomains = [
                    'theverge.com', 'techcrunch.com', 'wired.com',
                    'engadget.com', 'arstechnica.com', 'gizmodo.com',
                    'forbes.com', 'businessinsider.com', 'bloomberg.com',
                    'reuters.com', 'apnews.com', 'bbc.com'
                  ];
                  
                  if (premiumDomains.some(domain => hostname.includes(domain))) {
                    currentScore += 30;
                  } else if (industryDomains.some(domain => hostname.includes(domain))) {
                    currentScore += 20;
                  }
                  
                  // Content quality checks
                  if (result.title.length > 20 && result.title.length < 100) currentScore += 10;
                  if (result.snippet && result.snippet.length > 100) currentScore += 15;
                  if (result.date) currentScore += 10;
                  
                  // Update best result if higher quality
                  if (currentScore > qualityScore) {
                    bestResult = result;
                    qualityScore = currentScore;
                    bestResult.hostname = hostname;
                    bestResult.qualityScore = currentScore;
                  }
                  
                } catch (e) {
                  // Invalid URL, skip
                }
              }
              
              // If no result found, use first organic result
              if (!bestResult.title && organic.length > 0) {
                bestResult = organic[0];
                try {
                  const url = new URL(bestResult.link || '');
                  bestResult.hostname = url.hostname;
                } catch (e) {
                  bestResult.hostname = 'unknown';
                }
                bestResult.qualityScore = 5;
              }
              
              // Extract People Also Ask questions
              let questions = [];
              const questionSources = [
                searchData.related_questions,
                searchData.related_questions_and_answers,
                searchData.inline_questions,
                searchData.organic_results?.[0]?.related_questions
              ];
              
              for (const source of questionSources) {
                if (Array.isArray(source) && source.length > 0) {
                  source.slice(0, 5).forEach(item => {
                    if (item.question) questions.push(item.question);
                    else if (typeof item === 'string') questions.push(item);
                  });
                  if (questions.length >= 3) break;
                }
              }
              
              // Generate fallback questions if needed
              if (questions.length < 3) {
                const queryWords = query.toLowerCase().split(' ').slice(0, 4);
                const fallbacks = [
                  `What are the latest developments in ${queryWords.slice(0, 3).join(' ')}?`,
                  `How is ${queryWords.slice(0, 2).join(' ')} impacting modern music production?`,
                  `What should producers know about ${queryWords.slice(0, 2).join(' ')} in ${new Date().getFullYear()}?`,
                  `How can artists use ${queryWords.slice(0, 2).join(' ')} to improve their workflow?`
                ];
                questions = [...questions, ...fallbacks.slice(0, 5 - questions.length)];
              }
              
              // Calculate base trend score
              let trendScore = 40;
              trendScore += 25; // Recency bonus
              
              const totalResults = searchData.search_information?.total_results || 0;
              if (totalResults > 1000000) trendScore += 10;
              if (totalResults > 5000000) trendScore += 5;
              
              if (qualityScore > 30) trendScore += 15;
              else if (qualityScore > 20) trendScore += 10;
              else if (qualityScore > 10) trendScore += 5;
              
              if (questions.length >= 3) trendScore += 5;
              
              trendScore = Math.min(Math.max(trendScore, 40), 95);
              
              // Categorize the topic
              let category = 'OTHER';
              const queryLower = query.toLowerCase();
              if (queryLower.includes('ai') || queryLower.includes('artificial')) category = 'ü§ñ AI TOOLS';
              else if (queryLower.includes('gear') || queryLower.includes('hardware') || queryLower.includes('equipment')) category = 'üéõÔ∏è GEAR';
              else if (queryLower.includes('news') || queryLower.includes('industry') || queryLower.includes('trend')) category = 'üì∞ NEWS';
              else if (queryLower.includes('production') || queryLower.includes('studio') || queryLower.includes('recording')) category = 'üéöÔ∏è PRODUCTION';
              
              return {
                query,
                category,
                score: Math.round(trendScore),
                link: bestResult.link || 'https://example.com/no-link-found',
                title: bestResult.title || `Latest updates: ${query.slice(0, 50)}`,
                snippet: bestResult.snippet || `Stay informed about ${query.slice(0, 30)}...`,
                questions: [...new Set(questions)].slice(0, 5),
                total_results: totalResults,
                quality_score: qualityScore,
                source: bestResult.hostname || 'unknown'
              };
              
            } catch (error) {
              console.error(`‚ùå Regular SERP error for "${query}":`, error.message);
              throw error;
            }
          }
          
          function getFallbackSerpData(query) {
            const fallbackQuestions = [
              `What are the latest trends in ${query.split(' ').slice(0, 3).join(' ')}?`,
              `How is ${query.split(' ').slice(0, 2).join(' ')} impacting music production?`,
              `What should producers know about ${query.split(' ').slice(0, 2).join(' ')}?`
            ];
            
            return {
              query,
              category: 'ERROR',
              score: 40,
              link: 'https://example.com/no-link-found',
              title: `Latest updates on ${query}`,
              snippet: `Stay informed about the latest developments in ${query}`,
              questions: fallbackQuestions,
              status: '‚ùå ERROR',
              total_results: 0,
              quality_score: 0,
              source: 'error',
              ai_enhanced: false,
              ai_insights: []
            };
          }
          
          async function sendToDiscordChannel(content) {
            try {
              const url = `https://discord.com/api/v10/channels/${DISCORD_CHANNEL_ID}/messages`;
              
              console.log('üì§ Sending message to Discord channel...');
              
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Authorization': `Bot ${DISCORD_BOT_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content.slice(0, 2000) })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Discord API error: ${response.status} - ${errorText}`);
              } else {
                console.log('‚úÖ Message sent to Discord successfully');
              }
            } catch (error) {
              console.error('‚ùå Failed to send to Discord channel:', error);
              throw error;
            }
          }
          
          async function runEnhancedDailyScout() {
            try {
              console.log('üéØ Starting enhanced daily scout with AI APIs...');
              
              // Generate dynamic queries
              const { queries, theme, dateInfo } = generateDailyQueries();
              const dailyTopics = [];
              
              // Get SERP data for each query
              for (let i = 0; i < queries.length; i++) {
                const query = queries[i];
                try {
                  const serpData = await getEnhancedSerpData(query, {
                    isNews: query.toLowerCase().includes('news')
                  });
                  dailyTopics.push({
                    ...serpData,
                    index: i
                  });
                  console.log(`‚úÖ Processed query ${i + 1}: ${query.slice(0, 40)}...`);
                  
                  // Rate limiting between queries
                  if (i < queries.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                  }
                } catch (error) {
                  console.error(`‚ùå Error processing query "${query}":`, error);
                }
              }
              
              // Build enhanced report
              const dateStr = new Date().toISOString().split('T')[0];
              let report = `üé∏ **SOUNDSWAP DAILY BLOG SCOUT**\n`;
              report += `üìÖ ${dateInfo.dayOfWeek}, ${dateInfo.month}/${dateInfo.dayOfMonth}/${dateInfo.year}\n`;
              report += `üéØ Monthly Theme: ${theme}\n`;
              report += `ü§ñ AI APIs: Google AI Mode + AI Overview Enabled\n\n`;
              report += "**Choose ONE topic for today's semantic SEO blog:**\n\n";
              
              // Sort by score for better presentation
              dailyTopics.sort((a, b) => b.score - a.score);
              
              for (let i = 0; i < dailyTopics.length; i++) {
                const topic = dailyTopics[i];
                const emoji = ["üî•", "üìà", "üéØ", "‚ö°"][i] || "üìù";
                const categoryEmoji = topic.category;
                const aiBadge = topic.ai_enhanced ? 'ü§ñ ' : '';
                const paaPreview = topic.questions?.length > 0 ? 
                  `${topic.questions[0].slice(0, 50)}...` : "What music creators need to know";
                
                report += `${emoji} **${aiBadge}${categoryEmoji} ${topic.query.slice(0, 50)}...**\n`;
                report += `   üìä Trend Score: ${topic.score}/100 ${topic.status}\n`;
                report += `   üè∑Ô∏è Source: ${topic.source || 'Various'}\n`;
                if (topic.ai_insights && topic.ai_insights.length > 0) {
                  report += `   üí° AI Insight: ${topic.ai_insights[0].slice(0, 40)}...\n`;
                }
                report += `   üîó Reference: ${topic.link.slice(0, 60)}...\n`;
                report += `   ‚ùì Top PAA: ${paaPreview}\n\n`;
              }
              
              report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
              report += "**üöÄ ENHANCED FEATURES:**\n";
              report += "- ü§ñ Google AI Mode API (AI-generated results)\n";
              report += "- üß† Google AI Overview API (AI overview blocks)\n";
              report += "- üîç Multi-source question extraction\n";
              report += "- üìà AI-enhanced trend scoring\n\n";
              report += "**üí° BLOG GENERATION INSTRUCTIONS:**\n";
              report += "1. Type `/blog` in this channel\n";
              report += "2. Choose topic number (1-4)\n";
              report += "3. Select outline style\n";
              report += "4. Get full semantic SEO blog with PAA ‚Üí H3 headers!\n\n";
              report += "‚è±Ô∏è *Only 1 high-quality blog per day for maximum SEO impact*\n";
              report += "‚úÖ *Previous blogs indexed in <5 hours*\n";
              report += "ü§ñ *AI-enhanced topics for better search visibility*";
              
              // Send to Discord
              await sendToDiscordChannel(report);
              
              console.log('‚úÖ Enhanced daily scout completed successfully');
              
              return {
                success: true,
                date: dateStr,
                theme,
                topicsProcessed: dailyTopics.length,
                discordSent: true,
                topics: dailyTopics.map(t => ({
                  query: t.query,
                  score: t.score,
                  category: t.category,
                  ai_enhanced: t.ai_enhanced
                })),
                timestamp: new Date().toISOString()
              };
              
            } catch (error) {
              console.error('‚ùå Scout execution error:', error);
              throw error;
            }
          }
          
          // Execute
          runEnhancedDailyScout().then(result => {
            console.log('üéâ Enhanced scout completed:', JSON.stringify(result, null, 2));
            process.exit(0);
          }).catch(error => {
            console.error('üí• Scout failed:', error);
            process.exit(1);
          });
          EOF
          
          # Run the enhanced scout script
          node scout-runner.js
          
          # Save the exit code
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT

      - name: Trigger Vercel Endpoint (Fallback)
        if: steps.scout.outputs.EXIT_CODE != '0' && env.VERCEL_URL != '' && env.CRON_SECRET != ''
        run: |
          echo "üîÑ Falling back to Vercel endpoint..."
          
          # Validate URL format
          if [[ ! $VERCEL_URL =~ ^https?:// ]]; then
            echo "‚ùå ERROR: VERCEL_URL must start with http:// or https://"
            exit 1
          fi
          
          # Construct full API URL
          API_URL="${VERCEL_URL%/}/api/scout-direct"
          echo "üì° Calling: $API_URL"
          
          # Set up curl options
          CURL_OPTS=(
            -X POST
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $CRON_SECRET"
            --max-time 60
            --retry 2
            --retry-delay 5
          )
          
          # Make the request
          if curl "${CURL_OPTS[@]}" "$API_URL"; then
            echo "‚úÖ Vercel endpoint triggered successfully"
          else
            echo "‚ùå Failed to trigger Vercel endpoint"
          fi

      - name: Notify Completion
        if: always()
        run: |
          echo "‚úÖ GitHub Actions workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "----------------------------------------"
          echo "üéØ ENHANCED FEATURES:"
          echo "‚Ä¢ Google AI Mode API integration"
          echo "‚Ä¢ Google AI Overview API integration"
          echo "‚Ä¢ Multi-source question extraction"
          echo "‚Ä¢ AI-enhanced trend scoring"
          echo "----------------------------------------"
          echo "üìä Next steps:"
          echo "1. Check Discord for AI-enhanced topics"
          echo "2. Topics now include AI-generated insights"
          echo "3. Better PAA question extraction"
          echo "4. Continue rapid Google indexing (<5 hours)"
          echo "----------------------------------------"
          
          # Output status based on exit code
          if [ "${{ steps.scout.outputs.EXIT_CODE }}" = "0" ]; then
            echo "üéâ Enhanced AI scout executed successfully!"
            echo "ü§ñ AI APIs are now enriching your daily topics"
          else
            echo "‚ö† Scout script may have encountered issues"
            echo "Check the logs above for error details"
          fi