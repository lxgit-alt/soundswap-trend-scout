name: SoundSwap Daily Blog Scout

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 09:00 UTC
  workflow_dispatch:  # Allows manual triggering

jobs:
  daily-blog-scout:
    runs-on: ubuntu-latest
    env:
      VERCEL_URL: ${{ secrets.VERCEL_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Debug - Show Environment Status
        run: |
          echo "Checking environment variables..."
          
          # Check required variables
          REQUIRED_VARS=("SERPAPI_KEY" "DISCORD_BOT_TOKEN" "DISCORD_CHANNEL_ID")
          ALL_SET=true
          
          for var in "${REQUIRED_VARS[@]}"; do
            # Step 1: Get the value of the variable whose name is stored in $var
            val="${!var}"
            
            if [ -z "$val" ]; then
              echo "‚ùå $var is NOT set"
              ALL_SET=false
            else
              # Step 2: Get the length of the string stored in $val
              echo "‚úì $var is set (length: ${#val} chars)"
            fi
          done
          
          if [ "$ALL_SET" = false ]; then
            echo "üö® ERROR: Missing required environment variables!"
            echo "Please set all required variables in GitHub Secrets:"
            echo "1. SERPAPI_KEY"
            echo "2. DISCORD_BOT_TOKEN"
            echo "3. DISCORD_CHANNEL_ID"
            exit 1
          fi
          
          # Check optional variables
          if [ -n "$VERCEL_URL" ]; then
            echo "‚úì VERCEL_URL is set (length: ${#VERCEL_URL} chars)"
          else
            echo "‚ö† VERCEL_URL is not set (optional for direct API call)"
          fi
          
          if [ -n "$CRON_SECRET" ]; then
            echo "‚úì CRON_SECRET is set"
          else
            echo "‚ö† CRON_SECRET is not set (optional for direct API call)"
          fi

      - name: Run Direct Scout Script
        id: scout
        continue-on-error: true
        run: |
          echo "üöÄ Starting daily scout script..."
          echo "Current directory: $(pwd)"
          echo "Node version: $(node --version)"
          
          # Create a simple scout script
          cat > scout-runner.js << 'EOF'
          import fetch from 'node-fetch';
          
          // Configuration
          const SERPAPI_KEY = process.env.SERPAPI_KEY;
          const DISCORD_BOT_TOKEN = process.env.DISCORD_BOT_TOKEN;
          const DISCORD_CHANNEL_ID = process.env.DISCORD_CHANNEL_ID;
          
          // Niche queries
          const NICHE_QUERIES = [
            "latest music production gear releases 2026",
            "breaking AI audio tools for artists",
            "independent music marketing trends 2026",
            "music streaming industry news today"
          ];
          
          async function getSerpData(query) {
            try {
              console.log(`Fetching SERP data for: ${query}`);
              
              // Get search results with better parameters
              const searchUrl = `https://serpapi.com/search?q=${encodeURIComponent(query)}&tbs=qdr:d&num=10&api_key=${SERPAPI_KEY}`;
              const searchResponse = await fetch(searchUrl);
              const searchData = await searchResponse.json();
              
              console.log(`SERP API response received for: ${query}`);
              
              // Extract organic results
              const organic = searchData.organic_results || [];
              
              // Filter out social media and low-quality domains
              const excludedDomains = [
                'facebook.com', 'twitter.com', 'instagram.com', 
                'youtube.com', 'reddit.com', 'tiktok.com',
                'pinterest.com', 'linkedin.com', 'quora.com',
                'wikipedia.org', 'yelp.com', 'amazon.com'
              ];
              
              // Find a high-quality result
              let firstResult = {};
              for (const result of organic) {
                if (!result.link) continue;
                
                try {
                  const url = new URL(result.link);
                  const hostname = url.hostname.toLowerCase();
                  
                  // Check if domain is excluded
                  if (excludedDomains.some(domain => hostname.includes(domain))) {
                    continue;
                  }
                  
                  // Prefer certain high-quality domains
                  const preferredDomains = [
                    'musictech.com', 'musically.com', 'digitalmusicnews.com',
                    'billboard.com', 'rollingstone.com', 'nme.com',
                    'variety.com', 'theguardian.com', 'nytimes.com',
                    'techcrunch.com', 'wired.com', 'theverge.com',
                    'soundonsound.com', 'musicradar.com', 'producerspot.com'
                  ];
                  
                  // Check if this is a preferred domain
                  const isPreferred = preferredDomains.some(domain => hostname.includes(domain));
                  
                  if (result.title && result.snippet && (isPreferred || !firstResult.title)) {
                    firstResult = result;
                    if (isPreferred) break; // Found a preferred domain, use it
                  }
                } catch (e) {
                  console.log(`Invalid URL: ${result.link}`);
                }
              }
              
              // If no result found, use first organic result
              if (!firstResult.title && organic.length > 0) {
                firstResult = organic[0];
              }
              
              // Extract People Also Ask questions - FIXED
              let questions = [];
              
              // Method 1: Check for related_questions array
              if (searchData.related_questions && Array.isArray(searchData.related_questions)) {
                questions = searchData.related_questions
                  .slice(0, 5)
                  .map(q => q.question || q)
                  .filter(q => q && typeof q === 'string' && q.trim().length > 0);
              }
              
              // Method 2: Check for related_questions_and_answers
              if (questions.length === 0 && searchData.related_questions_and_answers) {
                questions = searchData.related_questions_and_answers
                  .slice(0, 5)
                  .map(item => {
                    if (typeof item === 'string') return item;
                    if (item.question) return item.question;
                    if (item.title) return item.title;
                    return null;
                  })
                  .filter(q => q && typeof q === 'string' && q.trim().length > 0);
              }
              
              // Method 3: Check for inline_questions (sometimes present)
              if (questions.length === 0 && searchData.inline_questions) {
                questions = searchData.inline_questions
                  .slice(0, 5)
                  .map(q => q.question || q)
                  .filter(q => q && typeof q === 'string' && q.trim().length > 0);
              }
              
              // Method 4: If still no questions, extract from snippet or generate fallbacks
              if (questions.length === 0) {
                const fallbackQuestions = [
                  `What are the latest developments in ${query.split(' ').slice(0, 3).join(' ')}?`,
                  `How is ${query.split(' ').slice(0, 2).join(' ')} changing the music industry?`,
                  `What do producers need to know about ${query.split(' ').slice(0, 2).join(' ')}?`,
                  `How can artists benefit from ${query.split(' ').slice(0, 2).join(' ')}?`,
                  `What are the key trends in ${query.split(' ').slice(0, 3).join(' ')}?`
                ];
                questions = fallbackQuestions.slice(0, 3);
              }
              
              // Calculate trend score based on multiple factors
              let trendScore = 50; // Base score
              
              // Factor 1: Recency (recent articles get higher score)
              trendScore += 20;
              
              // Factor 2: Number of results
              const totalResults = searchData.search_information?.total_results || 0;
              if (totalResults > 1000000) trendScore += 10;
              if (totalResults > 10000000) trendScore += 5;
              
              // Factor 3: Domain authority (if from preferred domain)
              try {
                const url = new URL(firstResult.link || '');
                const hostname = url.hostname.toLowerCase();
                const preferredDomains = [
                  'musictech.com', 'musically.com', 'digitalmusicnews.com',
                  'billboard.com', 'rollingstone.com', 'nme.com'
                ];
                if (preferredDomains.some(domain => hostname.includes(domain))) {
                  trendScore += 15;
                }
              } catch (e) {
                // Ignore URL parsing errors
              }
              
              // Ensure score is between 50-100
              trendScore = Math.min(Math.max(trendScore, 50), 100);
              
              let status = 'üìä STEADY';
              if (trendScore > 75) status = 'üî• VIRAL';
              else if (trendScore > 50) status = 'üìà TRENDING';
              
              return {
                query,
                score: Math.round(trendScore),
                link: firstResult.link || 'https://example.com/no-link-found',
                title: firstResult.title || 'No title available',
                snippet: firstResult.snippet || 'No snippet available',
                questions: questions.slice(0, 5),
                status,
                total_results: totalResults
              };
            } catch (error) {
              console.error(`SERP API error for "${query}":`, error.message);
              // Generate better fallback data
              const fallbackQuestions = [
                `What are the latest trends in ${query.split(' ').slice(0, 3).join(' ')}?`,
                `How is ${query.split(' ').slice(0, 2).join(' ')} impacting music production?`,
                `What should producers know about ${query.split(' ').slice(0, 2).join(' ')}?`,
                `How can artists use ${query.split(' ').slice(0, 2).join(' ')} effectively?`,
                `What are the benefits of ${query.split(' ').slice(0, 2).join(' ')} for musicians?`
              ];
              
              return {
                query,
                score: 50,
                link: 'https://example.com/no-link-found',
                title: `Latest updates on ${query}`,
                snippet: `Stay informed about the latest developments in ${query}`,
                questions: fallbackQuestions.slice(0, 3),
                status: 'üìä STEADY',
                total_results: 0
              };
            }
          }
          
          async function sendToDiscordChannel(content) {
            try {
              const url = `https://discord.com/api/v10/channels/${DISCORD_CHANNEL_ID}/messages`;
              
              console.log('Sending message to Discord channel...');
              
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Authorization': `Bot ${DISCORD_BOT_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content.slice(0, 2000) })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Discord API error: ${response.status} - ${errorText}`);
              } else {
                console.log('‚úÖ Message sent to Discord successfully');
              }
            } catch (error) {
              console.error('Failed to send to Discord channel:', error);
              throw error;
            }
          }
          
          async function runDailyScout() {
            try {
              console.log('Executing daily scout...');
              
              const dailyTopics = [];
              
              // Get SERP data for each query
              for (let i = 0; i < NICHE_QUERIES.length; i++) {
                const query = NICHE_QUERIES[i];
                try {
                  const serpData = await getSerpData(query);
                  dailyTopics.push({
                    ...serpData,
                    index: i
                  });
                  console.log(`‚úÖ Got data for query ${i + 1}: ${query}`);
                } catch (error) {
                  console.error(`‚ùå Error processing query "${query}":`, error);
                }
              }
              
              // Build report
              const dateStr = new Date().toISOString().split('T')[0];
              let report = `üé∏ **SOUNDSWAP DAILY BLOG TOPICS** (${dateStr})\n\n`;
              report += "**Choose ONE topic for today's semantic SEO blog:**\n\n";
              
              for (let i = 0; i < dailyTopics.length; i++) {
                const topic = dailyTopics[i];
                const emoji = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£"][i];
                const paaPreview = topic.questions?.length > 0 ? 
                  `${topic.questions[0].slice(0, 40)}...` : "What producers need to know";
                
                report += `${emoji} **${topic.query.toUpperCase()}**\n`;
                report += `   üìä Trend: ${topic.score}/100 ${topic.status}\n`;
                report += `   üîó Source: ${topic.link.slice(0, 50)}...\n`;
                report += `   ‚ùì PAA: ${paaPreview}\n\n`;
              }
              
              report += "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n";
              report += "**TO GENERATE BLOG:**\n";
              report += "1. Type `/blog` in this channel\n";
              report += "2. Choose topic (1-4)\n";
              report += "3. Choose outline style\n";
              report += "4. Get semantic SEO blog with PAA ‚Üí H3 headers!\n\n";
              report += "‚è±Ô∏è *Only 1 blog per day for maximum SEO impact*";
              
              // Send to Discord
              await sendToDiscordChannel(report);
              
              console.log('‚úÖ Daily scout completed successfully');
              
              return {
                success: true,
                topicsProcessed: dailyTopics.length,
                discordSent: true,
                timestamp: new Date().toISOString()
              };
              
            } catch (error) {
              console.error('‚ùå Scout execution error:', error);
              throw error;
            }
          }
          
          // Execute
          runDailyScout().then(result => {
            console.log('üéâ Scout completed:', JSON.stringify(result, null, 2));
            process.exit(0);
          }).catch(error => {
            console.error('üí• Scout failed:', error);
            process.exit(1);
          });
          EOF
          
          # Run the scout script
          node scout-runner.js
          
          # Save the exit code
          echo "EXIT_CODE=$?" >> $GITHUB_OUTPUT

      - name: Trigger Vercel Endpoint (Fallback)
        if: steps.scout.outputs.EXIT_CODE != '0' && env.VERCEL_URL != '' && env.CRON_SECRET != ''
        run: |
          echo "üîÑ Falling back to Vercel endpoint..."
          
          # Validate URL format
          if [[ ! $VERCEL_URL =~ ^https?:// ]]; then
            echo "‚ùå ERROR: VERCEL_URL must start with http:// or https://"
            exit 1
          fi
          
          # Construct full API URL
          API_URL="${VERCEL_URL%/}/api/scout-direct"
          echo "üì° Calling: $API_URL"
          
          # Set up curl options
          CURL_OPTS=(
            -X POST
            -H "Content-Type: application/json"
            -H "Authorization: Bearer $CRON_SECRET"
            --max-time 60
            --retry 2
            --retry-delay 5
          )
          
          # Make the request
          if curl "${CURL_OPTS[@]}" "$API_URL"; then
            echo "‚úÖ Vercel endpoint triggered successfully"
          else
            echo "‚ùå Failed to trigger Vercel endpoint"
          fi

      - name: Notify Completion
        if: always()
        run: |
          echo "‚úÖ GitHub Actions workflow completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "----------------------------------------"
          echo "Next steps:"
          echo "1. Check your Discord channel for the daily topics report"
          echo "2. If no report appears in 2 minutes, check the logs above"
          echo "3. Users can use /blog command to generate full articles"
          echo "----------------------------------------"
          echo "To debug:"
          echo "- Check GitHub Actions logs above"
          echo "- Verify Discord bot has proper permissions in your server"
          echo "- Check SERPAPI key is valid and has credits"
          echo "----------------------------------------"
          
          # Output status based on exit code
          if [ "${{ steps.scout.outputs.EXIT_CODE }}" = "0" ]; then
            echo "üéâ Scout script executed successfully!"
          else
            echo "‚ö† Scout script may have encountered issues"
            echo "Check the logs above for error details"
          fi